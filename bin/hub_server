#!/usr/bin/env ruby
# frozen_string_literal: true

require 'yaml'
require 'rack'

handler = nil
handler_name = nil
begin
  require 'puma'
  require 'rack/handler/puma'
  handler = Rack::Handler::Puma
  handler_name = :puma
rescue LoadError
  begin
    require 'webrick'
    require 'rack/handler/webrick'
    handler = Rack::Handler::WEBrick
    handler_name = :webrick
  rescue LoadError
    warn 'No Rack handler available. Install the puma or webrick gems.'
    exit 1
  end
end
require 'fileutils'

require_relative '../lib/savant/hub'

def base_path
  return ENV['SAVANT_PATH'] unless ENV['SAVANT_PATH'].to_s.empty?
  File.expand_path('..', __dir__)
end

def transport_config
  path = File.join(base_path, 'config', 'transport.yml')
  return {} unless File.file?(path)
  YAML.safe_load(File.read(path)) || {}
rescue StandardError
  {}
end

def mounts_config
  path = File.join(base_path, 'config', 'mounts.yml')
  return {} unless File.file?(path)
  YAML.safe_load(File.read(path)) || {}
rescue StandardError
  {}
end

default_host = '0.0.0.0'
default_port = 9999

host = nil
port = nil

ARGV.each do |arg|
  host = arg.split('=', 2)[1] if arg.start_with?('--host=')
  port = Integer(arg.split('=', 2)[1]) if arg.start_with?('--port=')
  if ['--help', '-h'].include?(arg)
    puts 'Usage: bin/hub_server [--host=HOST] [--port=PORT]'
    exit 0
  end
end

cfg = transport_config
config_host = cfg.dig('transport', 'host')
config_port = cfg.dig('transport', 'port')
env_host = ENV['SAVANT_HOST'] || ENV['LISTEN_HOST']
env_port = ENV['SAVANT_PORT'] || ENV['LISTEN_PORT']

# Precedence: CLI > ENV > config > default
host = (host || env_host || config_host || default_host)
port = Integer(port || env_port || config_port || default_port)

app = Savant::Hub.build_from_config(base_path: base_path)

log_dir = ENV['SAVANT_LOG_PATH'] || '/tmp/savant'
FileUtils.mkdir_p(log_dir)
STDOUT.sync = true
STDERR.sync = true

puts "Savant Hub starting on #{host}:#{port} (logs: #{log_dir})"
if handler_name == :webrick
  handler.run(app, Host: host, Port: port, AccessLog: [], Logger: WEBrick::Log.new(nil, 0))
else
  # Puma
  handler.run(app, Host: host, Port: port)
end
