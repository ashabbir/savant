#!/usr/bin/env ruby
# frozen_string_literal: true

require 'pg'

def env_flag(name, default = nil)
  v = ENV[name]
  (v && !v.to_s.empty?) ? v : default
end

db_env = (env_flag('DB_ENV', env_flag('RAILS_ENV', env_flag('RACK_ENV', 'development')))).to_s
db_name = env_flag('DB_NAME', db_env == 'test' ? 'savant_test' : 'savant_development')
host = env_flag('PGHOST', 'localhost')
port = (env_flag('PGPORT', 5432)).to_i
user = env_flag('PGUSER', nil)
password = env_flag('PGPASSWORD', nil)

params = { host: host, port: port, dbname: 'postgres' }
params[:user] = user if user
params[:password] = password if password

begin
  conn = PG.connect(params)
  # Terminate existing connections to the target DB
  conn.exec_params("SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = $1 AND pid <> pg_backend_pid()", [db_name])
  conn.exec("DROP DATABASE IF EXISTS \"#{db_name}\"")
  puts "Dropped database #{db_name}"
  conn.close
  exit 0
rescue StandardError => e
  warn "DB DROP ERROR: #{e.class}: #{e.message}"
  exit 1
end

