#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative '../lib/savant/framework/db'

begin
  db = Savant::Framework::DB.new
  if ENV['SAVANT_DESTRUCTIVE'] == '1'
    warn 'WARNING: destructive migration â€” dropping and recreating all tables'
    db.migrate_tables
    db.ensure_fts
    puts 'DB RESET COMPLETE (tables + FTS ready)'
  else
    applied = db.apply_migrations
    puts "DB MIGRATIONS APPLIED: #{applied.length} (#{applied.join(', ')})"
  end
  exit 0
rescue StandardError => e
  warn "DB ERROR: #{e.class}: #{e.message}"
  exit 1
end
