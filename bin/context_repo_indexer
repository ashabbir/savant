#!/usr/bin/env ruby
# frozen_string_literal: true

require 'time'
require_relative '../lib/savant/context/fs/repo_indexer'
require_relative '../lib/savant/db'

def usage!
  warn 'usage: context_repo_indexer index all | index <repo> | delete all | delete <repo> | status'
  exit 2
end

cmd = ARGV.shift
usage! unless cmd

logger = Savant::Logger.new(io: $stdout, json: false, service: 'context.repo_indexer')
repo_indexer = Savant::Context::FS::RepoIndexer.new(db: Savant::DB.new, logger: logger)

begin
  case cmd
  when 'index'
    target = ARGV.shift
    repo = target == 'all' || target.nil? ? nil : target
    started = Time.now
    mode = repo ? "repo=#{repo}" : 'all'
    puts "CTX INDEX START ts=#{started.utc.iso8601} mode=#{mode}"
    res = repo_indexer.index(repo: repo, verbose: true)
    finished = Time.now
    dur = (finished - started).round(3)
    msg = "CTX INDEX DONE ts=#{finished.utc.iso8601} duration_s=#{dur} " \
          "total=#{res[:total]} changed=#{res[:changed]} skipped=#{res[:skipped]}"
    puts msg
  when 'delete'
    target = ARGV.shift
    usage! unless target
    repo = target == 'all' ? nil : target
    started = Time.now
    mode = repo ? "repo=#{repo}" : 'all'
    puts "CTX DELETE START ts=#{started.utc.iso8601} mode=#{mode}"
    res = repo_indexer.delete(repo: repo)
    finished = Time.now
    dur = (finished - started).round(3)
    msg = "CTX DELETE DONE ts=#{finished.utc.iso8601} duration_s=#{dur} " \
          "deleted=#{res[:deleted]} count=#{res[:count]}"
    puts msg
  when 'status'
    rows = repo_indexer.status
    begin
      raw = Savant::Config.load('config/settings.json')
      icfg = Savant::Indexer::Config.new(raw)
      scan_str = (icfg.scan_mode == :git ? 'git-ls' : 'ls')
    rescue StandardError
      scan_str = 'unknown'
    end
    puts "CTX STATUS ts=#{Time.now.utc.iso8601} repos=#{rows.length} scanMode=#{scan_str}"
    rows.each do |r|
      line = "repo=#{r['name']} files=#{r['files']} blobs=#{r['blobs']} " \
             "chunks=#{r['chunks']} last_mtime=#{r['last_mtime'] || '-'}"
      puts line
    end
  else
    usage!
  end
  exit 0
rescue StandardError => e
  warn "CTX INDEXER ERROR: #{e.class}: #{e.message}"
  exit 1
end
