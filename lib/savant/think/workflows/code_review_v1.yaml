name: code_review_v1
version: "1.2"
description: "Comprehensive MR code review flow based on .clinerules/workflows/code-review.md (use .cline/rules/*)"
steps:
  # Phase 1: Initial Setup & Context Loading
  - id: load_rules
    call: local.read
    input_template:
      files:
        # Prefer underscore rule file names (compat with .clinerules/INDEX.md)
        - ".cline/rules/code_review_rules.md"
        - ".cline/rules/backend_rules.md"
        - ".cline/rules/testing_rules.md"
        - ".cline/rules/style_rules.md"
        - ".cline/rules/savant_rules.md"
        # Fallbacks for hyphenated variants
        - ".cline/rules/code-review-rules.md"
        - ".cline/rules/backend-rules.md"
        - ".cline/rules/testing-rules.md"
        - ".cline/rules/style-rules.md"
        - ".cline/rules/savant-rules.md"
        - ".clinerules/INDEX.md"
    capture_as: rules_text

  - id: load_workflow_doc
    call: local.read
    deps: ["load_rules"]
    input_template:
      files: [".clinerules/workflows/code-review.md"]
    capture_as: workflow_doc

  - id: load_config
    call: local.read
    deps: ["load_workflow_doc"]
    input_template:
      files: [".cline/config.yml"]
    capture_as: project_config

  - id: parse_project_meta
    call: analysis.parse_project_meta
    deps: ["load_config"]
    input_template:
      config: "{{project_config}}"
    capture_as: project_meta

  - id: announce_project
    call: prompt.say
    deps: ["parse_project_meta"]
    input_template:
      text: |
        Project Meta Loaded:

        - GitLab Project ID: {{project_meta.project_gitlab}}

        - Project Code: {{project_meta.project_code}}

  - id: request_mr_iid
    call: prompt.ask
    deps: ["announce_project"]
    input_template:
      question: "Provide GitLab MR IID (e.g., !12345)"
      capture: "mr_iid"

  - id: confirm_task
    call: prompt.confirm
    deps: ["request_mr_iid"]
    input_template:
      question: "Confirm task type: Code Review?"
      expected: "yes"

  # Phase 2: Fetch MR Details
  - id: mr_details
    call: gitlab.get_merge_request
    deps: ["confirm_task"]
    input_template:
      project: "{{params.project_id}}"
      mr_iid: "{{params.mr_iid}}"
    capture_as: mr

  - id: extract_ticket
    call: analysis.extract_jira
    deps: ["mr_details"]
    input_template:
      title: "{{mr.title}}"
      pattern: '[A-Z]+-\d+'
    capture_as: ticket_key

  - id: jira_fetch
    call: jira_get_issue
    deps: ["extract_ticket"]
    input_template:
      key: "{{ticket_key}}"
    capture_as: jira

  # Phase 2.1: Branch checkout (announcement + checkout if needed)
  - id: checkout_branch
    call: local.exec
    deps: ["mr_details"]
    input_template:
      cmd: |
        git fetch origin {{mr.source_branch}} && git checkout {{mr.source_branch}}
      note: "Ensure you are on the MR source branch before analysis"

  # Phase 3: Code Analysis (changed files, understanding)
  - id: changed_files
    call: local.exec
    deps: ["checkout_branch"]
    input_template:
      cmd: |
        git diff --name-status origin/{{mr.target_branch}}...{{mr.source_branch}}
    capture_as: changes

  - id: understand_change
    call: analysis.graph
    deps: ["changed_files"]
    input_template:
      files: "{{changes}}"
      require_sequence_diagram: true
    capture_as: change_graph

  # Lint/Findings/Security — context + local verification
  - id: lint_signals_ctx
    call: fts/search
    deps: ["checkout_branch"]
    input_template:
      q: 'rubocop disable|linter disable'
    capture_as: lint_ctx

  - id: lint_signals_fs
    call: local.search
    deps: ["lint_signals_ctx"]
    input_template:
      q: 'rubocop:disable|linter disable'
      globs: ["**/*.rb", "**/*.yml", "**/*.yaml"]
    capture_as: lint_fs

  - id: debug_findings_ctx
    call: fts/search
    deps: ["checkout_branch"]
    input_template:
      q: 'TODO|FIXME|binding.pry|puts|console.log'
    capture_as: findings_ctx

  - id: debug_findings_fs
    call: local.search
    deps: ["debug_findings_ctx"]
    input_template:
      q: 'TODO|FIXME|binding.pry|puts|console.log'
      globs: ["**/*"]
    capture_as: findings_fs

  - id: security_ctx
    call: fts/search
    deps: ["checkout_branch"]
    input_template:
      q: 'permit_all|skip_auth|eval\(|OPENSSL_NO_VERIFY|system\(|`'
    capture_as: security_ctx

  - id: security_fs
    call: local.search
    deps: ["security_ctx"]
    input_template:
      q: 'permit_all|skip_auth|eval\(|OPENSSL_NO_VERIFY|system\(|`'
      globs: ["**/*"]
    capture_as: security_fs

  - id: rails_antipatterns_ctx
    call: fts/search
    deps: ["checkout_branch"]
    input_template:
      q: 'update_all\(|find_by_sql\(|exec_query\(|skip_before_action :authenticate_user|rescue Exception|before_filter|after_filter'
    capture_as: rails_anti_ctx

  - id: rails_antipatterns_fs
    call: local.search
    deps: ["rails_antipatterns_ctx"]
    input_template:
      q: 'update_all\(|find_by_sql\(|exec_query\(|skip_before_action :authenticate_user|rescue Exception|before_filter|after_filter'
      globs: ["**/*.rb"]
    capture_as: rails_anti_fs

  # Phase 4: Test Execution & Validation (affected paths first)
  - id: tests_affected
    call: local.exec
    deps: ["changed_files"]
    input_template:
      cmd: |
        bundle exec rspec $(git diff --name-only origin/{{mr.target_branch}}...{{mr.source_branch}} | sed -n 's#^\(spec/.*\)$#\1#p') -f documentation || true
      note: "Run tests for affected files if any; ignore if none"
    capture_as: tests_affected_output

  - id: rubocop
    call: local.exec
    deps: ["rails_antipatterns_fs"]
    input_template:
      cmd: |
        bundle exec rubocop -f progress || rubocop -f progress
      expect: "no offenses detected"
    capture_as: rubocop_output

  - id: rspec_full
    call: local.exec
    deps: ["rubocop"]
    input_template:
      cmd: |
        bundle exec rspec --format progress || rspec --format progress
      min_coverage: 85
      note: "Ensure coverage >= 85% (SimpleCov or builtin)"
    capture_as: rspec_output

  # Phase 5: Requirements Validation
  - id: requirements_map
    call: analysis.map_requirements
    deps: ["jira_fetch", "understand_change"]
    input_template:
      jira: "{{jira}}"
      files: "{{changes}}"
    capture_as: req_map

  # Phase 4 (Rules Application) in doc — apply code review rules
  - id: apply_rules
    call: analysis.apply_rules
    deps: ["requirements_map", "rubocop", "rspec_full"]
    input_template:
      rule_files:
        # Prefer underscore rule file names
        - ".cline/rules/code_review_rules.md"
        - ".cline/rules/backend_rules.md"
        - ".cline/rules/testing_rules.md"
        - ".cline/rules/style_rules.md"
        - ".cline/rules/savant_rules.md"
        # Fallbacks for hyphenated variants
        - ".cline/rules/code-review-rules.md"
        - ".cline/rules/backend-rules.md"
        - ".cline/rules/testing-rules.md"
        - ".cline/rules/style-rules.md"
        - ".cline/rules/savant-rules.md"
    capture_as: rules_assessment

  - id: issues_documentation
    call: analysis.issues_table
    deps: ["apply_rules"]
    input_template:
      sources:
        - "{{rules_assessment}}"
        - "{{findings_fs}}"
        - "{{security_fs}}"
        - "{{rails_anti_fs}}"
    capture_as: issues

  - id: quality_summary
    call: analysis.quality_summary
    deps: ["issues_documentation"]
    input_template:
      inputs:
        rubocop: "{{rubocop_output}}"
        rspec: "{{rspec_output}}"
        security: "{{security_fs}}"
        rails: "{{rails_anti_fs}}"
    capture_as: quality

  # Phase 5: Discussion Review
  - id: discussions
    call: gitlab.get_merge_request_discussions
    deps: ["mr_details"]
    input_template:
      project: "{{params.project_id}}"
      mr_iid: "{{params.mr_iid}}"
    capture_as: discussion_list

  - id: outstanding
    call: analysis.outstanding_items
    deps: ["discussions"]
    input_template:
      discussions: "{{discussion_list}}"
    capture_as: outstanding

  # Phase 6: Final Assessment
  - id: final_verdict
    call: analysis.final_matrix
    deps: ["quality_summary", "outstanding", "requirements_map"]
    input_template:
      thresholds: { coverage: 85 }
    capture_as: verdict

  # Phase 7: Deliverable
  - id: write_report
    call: local.write
    deps: ["final_verdict"]
    input_template:
      path: "code-reviews/{{ticket_key}}/{{timestamp}}.md"
      content_template: |
        # MR !{{params.mr_iid}} Final Review Report - {{ticket_key}}

        ## JIRA Compliance: {{ticket_key}}
        {{req_map}}

        ## Commit Analysis
        {{change_graph}}

        ## Code Review Rules Assessment
        {{rules_assessment}}

        ## Issues
        {{issues}}

        ## Quality Summary
        {{quality}}

        ## Outstanding Discussions
        {{outstanding}}

        ## Final Verdict
        {{verdict}}
