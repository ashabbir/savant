name: code_review_v2
version: "1.0"
driver_version: "stable-2025-11"
description: "Local-first code review with impact analysis, visuals (impact graph + sequence), and a safety decision with a single embedded report."
steps:
  # Intro and policy
  - id: announce_policy
    call: prompt.say
    input_template:
      text: |
        Code Review v2: Local-first, gated workflow.

        - Search policy: use ONLY local repo for project code analysis.
        - Cross‑repo/library impacts: use Context MCP `fts/search` and `memory/search` (no public web).
        - Gated phases: Impact Analysis → Impact Graph → Sequence Diagram → Safety Decision.
        - Outputs: A single report.md embedding all Mermaid visuals (no separate .mmd files).
        - Paths: reports/code_review_v2/<date>_<shortsha>/.
        - Keep payloads compact; prefer references over large blobs.

  # Change identification
  - id: compute_date
    call: local.exec
    deps: ["announce_policy"]
    input_template:
      cmd: |
        date +%Y-%m-%d
    capture_as: today

  - id: compute_shortsha
    call: local.exec
    deps: ["compute_date"]
    input_template:
      cmd: |
        git rev-parse --short HEAD
    capture_as: shortsha

  - id: resolve_change_set
    call: local.exec
    deps: ["compute_shortsha"]
    input_template:
      cmd: |
        # Determine change range: params.commit_range or params.base_ref..HEAD (default origin/main..HEAD)
        if [ -n "{{params.commit_range}}" ]; then RANGE="{{params.commit_range}}"; \
        elif [ -n "{{params.base_ref}}" ]; then RANGE="{{params.base_ref}}..HEAD"; \
        else RANGE="origin/main..HEAD"; fi; \
        git diff --name-status --find-renames --diff-filter=ACMRT "$RANGE"
      note: "Identify added/modified/renamed files in the change set."
    capture_as: changed_files

  - id: summarize_diff
    call: analysis.diff_summary
    deps: ["resolve_change_set"]
    input_template:
      diff: "{{changed_files}}"
      note: "Summarize by file, language, LOC, and intent. Keep concise."
    capture_as: change_summary

  # Jira ticket discovery and requirements understanding
  - id: current_branch
    call: local.exec
    deps: ["summarize_diff"]
    input_template:
      cmd: |
        git rev-parse --abbrev-ref HEAD
    capture_as: branch

  - id: head_commit_msg
    call: local.exec
    deps: ["current_branch"]
    input_template:
      cmd: |
        git log -1 --pretty=%B
    capture_as: head_msg

  - id: extract_ticket
    call: analysis.extract_jira
    deps: ["head_commit_msg"]
    input_template:
      title: "{{params.ticket_key}} {{branch}} {{head_msg}}"
      pattern: '[A-Z]+-\d+'
    capture_as: ticket_key

  - id: jira_fetch
    call: jira_get_issue
    deps: ["extract_ticket"]
    input_template:
      key: "{{ticket_key}}"
    capture_as: jira

  - id: requirements_summary
    call: analysis.requirements_summary
    deps: ["jira_fetch"]
    input_template:
      jira: "{{jira}}"
      note: "Summarize user-facing and system requirements; keep concise."
    capture_as: requirements

  - id: requirements_map
    call: analysis.map_requirements
    deps: ["requirements_summary"]
    input_template:
      jira: "{{jira}}"
      files: "{{changed_files}}"
      note: "Map Jira requirements to implementation locations (file:line refs)."
    capture_as: req_map

  # Gate 1: Impact analysis
  - id: gate_impact
    call: prompt.say
    deps: ["summarize_diff"]
    input_template:
      text: |
        Gate 1: Proceed with Impact Analysis?
        - Action: Map references, call sites, tests, and data/DB surfaces.
        - Policy: Local-first; cross‑repo via Context MCP `fts/search` + `memory/search` if needed.

  - id: impacted_areas
    call: analysis.impacted_areas
    deps: ["gate_impact"]
    input_template:
      sources:
        - "{{changed_files}}"
      include:
        - tests
        - fixtures
        - factories
        - mocks
        - migrations
        - schema
      policy: "Local-first (AST/static + ripgrep). Cross‑repo via Context FTS/Memory only."
      output: "Impacted Areas table: files, symbols, modules, services with evidence refs."
    capture_as: impacts

  - id: cross_repo_fts
    call: fts/search
    deps: ["impacted_areas"]
    input_template:
      q: "{{params.cross_repo_query}}"
      limit: 50
    capture_as: fts_hits

  - id: cross_repo_memory
    call: memory/search
    deps: ["impacted_areas"]
    input_template:
      q: "{{params.cross_repo_query}}"
      limit: 50
    capture_as: memory_hits

  - id: requirements_gap
    call: analysis.requirements_gap
    deps: ["cross_repo_memory"]
    input_template:
      requirements: "{{requirements}}"
      mapping: "{{req_map}}"
      impacts: "{{impacts}}"
      note: "Identify gaps between requirements and current implementation."
    capture_as: gaps

  # Gate 2: Impact graph
  - id: gate_graph
    call: prompt.say
    deps: ["cross_repo_memory"]
    input_template:
      text: |
        Gate 2: Generate the Impact Graph?
        - Build dependency graph (files/modules/classes; edges: calls/imports/usage). Max 150 nodes.
        - Highlight changed (red/orange) and impacted (yellow).

  - id: build_impact_graph
    call: analysis.impact_graph
    deps: ["gate_graph"]
    input_template:
      impacts: "{{impacts}}"
      style: "mermaid"
      max_nodes: 150
    capture_as: impact_graph_mmd

  # Gate 3: Sequence diagram
  - id: gate_sequence
    call: prompt.say
    deps: ["write_impact_graph"]
    input_template:
      text: |
        Gate 3: Generate Sequence Diagram(s)?
        - Identify entry points (routes/controllers/CLI/jobs) and user flow.
        - Highlight where the change occurs.

  - id: build_sequence
    call: analysis.sequence_diagram
    deps: ["gate_sequence"]
    input_template:
      impacts: "{{impacts}}"
      style: "mermaid"
      actors: ["User", "UI", "Controller", "Service", "DB", "External"]
    capture_as: sequence_mmd

  # Gate 4: Safety decision
  - id: gate_decision
    call: prompt.say
    deps: ["write_sequence"]
    input_template:
      text: |
        Gate 4: Make a Safety Decision (Safe / Needs Caution / Risky) with rationale.
        - Criteria: backward compatibility, contracts, migrations, exceptions, performance, toggle/rollback, coverage.

  - id: safety_decision
    call: analysis.safety_decision
    deps: ["gate_decision"]
    input_template:
      criteria:
        backward_compat: true
        contracts: true
        migrations: true
        exceptions: true
        performance: true
        toggle_or_rollback: true
        coverage_threshold: 85
      evidence:
        impacts: "{{impacts}}"
        fts: "{{fts_hits}}"
        memory: "{{memory_hits}}"
        requirements: "{{requirements}}"
        gaps: "{{gaps}}"
    capture_as: decision

  # Final report assembly (embeds visuals)
  - id: write_impacted_json
    call: local.write
    deps: ["safety_decision"]
    input_template:
      path: "reports/code_review_v2/{{today}}_{{shortsha}}/impacted_areas.json"
      content_template: "{{impacts}}"

  - id: write_report
    call: local.write
    deps: ["write_impacted_json", "build_impact_graph", "build_sequence"]
    input_template:
      path: "reports/code_review_v2/{{today}}_{{shortsha}}/report.md"
      content_template: |
        # Code Review v2 Report ({{today}} @ {{shortsha}})

        ## Change Summary
        {{change_summary}}

        ## Jira
        - Ticket: {{ticket_key}}
        - Summary & Requirements:
        {{requirements}}

        ## Impact Analysis
        {{impacts}}

        ## Impact Graph
        ```mermaid
        {{impact_graph_mmd}}
        ```

        ## Sequence Diagram
        ```mermaid
        {{sequence_mmd}}
        ```

        ## Requirements Mapping
        {{req_map}}

        ## Requirements Gap Analysis
        {{gaps}}

        ## Safety Decision
        {{decision}}

        ## Evidence Appendix
        - FTS hits: {{fts_hits}}
        - Memory hits: {{memory_hits}}
        - Changed files: {{changed_files}}
